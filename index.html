<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vinstory Club — каталог</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ========================= TOKENS (премиум-беж) ========================= */
    :root{
      --bg:#F3EFE8;           /* фон страницы */
      --panel:#F8F5EE;        /* фон модалок/панелей (чуть светлее фона) */
      --surface:#FFFFFF;      /* белые элементы/карточки/поля */
      --text:#1F1F1F;
      --text-muted:#6F6B65;
      --stroke:#E6DDD2;
      --accent:#232323;
      --accent-press:#1C1C1C;

      --r-lg:20px;            /* модалки */
      --r-md:14px;            /* чипы/поля/карточки */
      --shadow-panel:0 6px 20px rgba(0,0,0,.10);
      --shadow-chip:0 2px 8px rgba(0,0,0,.06);

      --title:18px;
      --name:16px;
      --meta:13px;
      --price:20px;

      --gap:16px;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:Inter, -apple-system, BlinkMacSystemFont, "SF Pro Text","Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.3;
    }
    a{color:inherit;text-decoration:none}
    body.modal-lock{position:fixed;overflow:hidden;width:100%}

    /* ========================= HEADER / TOOLBAR ========================= */
    header{position:sticky;top:0;z-index:50;background:var(--bg);padding:12px 16px;border-bottom:1px solid var(--stroke);
      display:flex;gap:12px;align-items:center}
    .logo{width:28px;height:28px;border-radius:12px;background:var(--surface);
      border:1px solid var(--stroke);display:grid;place-items:center;font-weight:800;letter-spacing:.3px;color:#111;box-shadow:var(--shadow-chip)}
    h1{margin:0;font-size:var(--title);font-weight:600;letter-spacing:.2px}

    .toolbar{position:sticky;top:56px;z-index:45;background:var(--bg);
      border-bottom:1px solid var(--stroke);padding:10px 16px;display:flex;gap:12px;align-items:center}
    .search{flex:1;display:flex;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--stroke);
      border-radius:var(--r-md);height:44px;padding:0 14px;box-shadow:var(--shadow-chip)}
    .search input{border:0;outline:none;background:transparent;width:100%;font-size:16px;color:var(--text)}
    .search input::placeholder{color:var(--text-muted)}
    .pill{background:var(--surface);border:1px solid var(--stroke);height:44px;padding:0 14px;border-radius:var(--r-md);
      box-shadow:var(--shadow-chip);cursor:pointer;color:var(--text);font:600 15px/44px Inter,system-ui;
      transition:transform .18s ease-out, opacity .18s ease-out}
    .pill:active{transform:scale(.98);opacity:.95}

    /* ========================= BRAND CHIPS (белые пилюли) ========================= */
    .cats{position:sticky;top:112px;z-index:40;background:var(--bg);border-bottom:1px solid var(--stroke);
      padding:6px 12px;overflow:auto;-webkit-overflow-scrolling:touch}
    .cats-row{display:flex;gap:8px}
    .cat-chip{
      white-space:nowrap;height:36px;padding:0 14px;border-radius:var(--r-md);
      background:var(--surface);border:1px solid var(--stroke);
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      color:var(--text);font:600 15px/36px Inter,system-ui;letter-spacing:.2px;cursor:pointer;
      transition:transform .18s ease-out, background .18s, color .18s, box-shadow .18s
    }
    .cat-chip:active{transform:scale(.98)}
    .cat-chip.active{background:var(--accent);color:#FFF;border:none;box-shadow:0 4px 12px rgba(0,0,0,.12)}

    /* ========================= GRID & CARD v2 ========================= */
    .wrap{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    @media (min-width:720px){ .cats{top:116px} .grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))} }

    .card{
      background:var(--surface);border:1px solid var(--stroke);border-radius:var(--r-md);
      overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow-chip);
      cursor:pointer;transition:transform .18s ease-out, filter .18s ease-out
    }
    .card:active{transform:scale(.98)}
    .thumb{width:100%;aspect-ratio:4/5;object-fit:cover;background:#F2ECE3;display:block}
    .card:active .thumb{filter:brightness(.96)}

    .body{padding:10px 12px 12px;display:flex;flex-direction:column;gap:6px}
    .title{margin:0;font-weight:600;font-size:var(--name);color:var(--text);line-height:1.25;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .meta{margin:0;font-size:var(--meta);color:var(--text-muted)}
    .bottom{display:flex;align-items:center;gap:8px;margin-top:2px}
    .price{margin:0;font-size:var(--price);font-weight:600;color:var(--text)}
    .ghost{margin-left:auto;height:36px;min-width:36px;padding:0 12px;border-radius:var(--r-md);
      background:transparent;border:1px solid var(--stroke);color:var(--text);font-weight:600;display:flex;align-items:center;justify-content:center}
    .ghost:active{transform:scale(.98);background:#F6F2EB}

    .empty{padding:48px 12px;text-align:center;color:var(--text-muted)}

    /* ========================= PRODUCT MODAL ========================= */
    .modal{position:fixed;inset:0;z-index:100;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25)}
    .modal.open{display:flex}
    .sheet{width:min(640px,96vw);max-height:92vh;background:var(--surface);border:1px solid var(--stroke);
      border-radius:var(--r-lg);overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow-panel)}
    .sheet header{background:var(--surface);border-bottom:1px solid var(--stroke);padding:14px 16px;display:flex;gap:8px;align-items:center}
    .sheet .close{margin-left:auto;background:transparent;border:0;color:var(--text-muted);font-weight:600;padding:6px 8px;border-radius:10px}
    .dialog-scroll{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;background:var(--surface)}
    .gallery{display:flex;align-items:center;justify-content:center}
    .big{max-height:54vh;max-width:100%;width:100%;object-fit:contain;background:var(--surface);display:block}
    .strip{display:flex;gap:6px;overflow:auto;padding:10px;border-top:1px solid var(--stroke);background:#EFE8DF}
    .strip img{height:70px;border-radius:12px;opacity:.9;cursor:pointer;border:1px solid var(--stroke);background:#F0EBE3}
    .strip img.active{outline:2px solid var(--accent);opacity:1}
    .content{padding:12px 16px;display:flex;flex-direction:column;gap:10px}
    .desc{font-size:15px;line-height:1.35;color:var(--text);white-space:pre-wrap}
    .buy{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid var(--stroke);background:var(--surface)}
    .buy .price{font-size:22px;font-weight:700}
    .btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:0 16px;height:44px;border-radius:var(--r-md);border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:700}
    .btn:active{background:var(--accent-press)}

    /* ========================= FILTERS MODAL (вернули «старую» механику) ========================= */
    .sheet.small{width:min(560px,96vw);background:var(--panel);box-shadow:0 20px 60px rgba(0,0,0,.18)}
    .sheet.small header{background:var(--panel);border-bottom:1px solid var(--stroke)}
    .form{display:flex;flex-direction:column;gap:14px;padding:20px 16px}
    .label{font-size:13px;color:var(--text-muted);margin-bottom:6px;font-weight:400}

    /* Поле/псевдо-кнопка */
    .select{min-width:140px;background:var(--surface);border:1px solid var(--stroke);border-radius:var(--r-md);
      padding:0 14px;height:44px;display:flex;align-items:center;box-shadow:var(--shadow-chip)}
    .native-select{appearance:none;-webkit-appearance:none;width:100%;border:0;background:transparent;color:var(--text);font:600 15px/44px Inter,system-ui;padding-right:22px}
    .native-wrap{position:relative}
    .native-wrap::after{content:"";position:absolute;right:14px;top:50%;width:9px;height:9px;border-right:2px solid #8B867F;border-bottom:2px solid #8B867F;transform:translateY(-50%) rotate(45deg);pointer-events:none}

    /* Аккордеоны */
    .acc{background:var(--surface);border:1px solid var(--stroke);border-radius:var(--r-md);box-shadow:var(--shadow-chip);overflow:hidden}
    .acc + .acc{margin-top:12px}
    .acc-h{display:flex;align-items:center;justify-content:space-between;height:48px;padding:0 14px;cursor:pointer}
    .acc-title{font-weight:600;color:var(--text)}
    .chev{width:10px;height:10px;border-right:2px solid #8B867F;border-bottom:2px solid #8B867F;transform:rotate(45deg);transition:transform .18s ease}
    .acc.open .chev{transform:rotate(-135deg)}
    .acc-b{display:none;padding:12px;border-top:1px solid var(--stroke);background:var(--panel)}
    .acc.open .acc-b{display:block}

    /* Цена */
    .price-row{display:flex;gap:12px;flex-wrap:wrap}
    .price-field{flex:1;min-width:120px;background:var(--surface);border:1px solid var(--stroke);border-radius:var(--r-md);box-shadow:var(--shadow-chip);
      padding:0 14px;height:44px;display:flex;align-items:center}
    .price-field input{border:0;outline:none;background:transparent;font:600 15px/44px Inter,system-ui;color:var(--text)}
    .range-wrap{position:relative;height:34px;margin-top:10px}
    .range{position:absolute;left:0;right:0;top:16px;height:2px;border-radius:999px;background:#E7E0D7}
    .range-fill{position:absolute;height:100%;border-radius:999px;background:var(--accent)}
    .thumb-range{position:absolute;left:0;right:0;top:0;width:100%;pointer-events:none;-webkit-appearance:none;appearance:none;background:transparent;height:34px}
    .thumb-range::-webkit-slider-thumb{pointer-events:auto;-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:#FFF;border:1px solid var(--stroke);box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .thumb-range::-moz-range-thumb{pointer-events:auto;width:18px;height:18px;border-radius:50%;background:#FFF;border:1px solid var(--stroke);box-shadow:0 2px 6px rgba(0,0,0,.12)}

    /* Размеры (поповер) */
    #sizeSelect{position:relative}
    #sizeCurrent{color:var(--text);font:600 15px/44px Inter,system-ui}
    #sizePopover{position:absolute;left:50%;transform:translateX(-50%);top:calc(100% + 8px);width:min(330px,88vw);max-height:72vh;overflow:auto;
      background:var(--surface);border:1px solid var(--stroke);border-radius:var(--r-md);box-shadow:var(--shadow-panel);padding:12px;display:none;z-index:200}
    #sizesBox{display:flex;gap:8px;flex-wrap:wrap}
    #sizesBox .chk input{display:none}
    #sizesBox .chk label{display:inline-block;border:1px solid var(--stroke);background:var(--surface);padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--text);font-weight:600}
    #sizesBox .chk input:checked + label{border-color:var(--accent);background:var(--accent);color:#fff}

    /* Бренды внутри аккордеона */
    .brand-search{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--stroke);border-radius:var(--r-md);padding:0 14px;height:44px;box-shadow:var(--shadow-chip)}
    .brand-search input{border:0;outline:none;background:transparent;width:100%;color:var(--text);font:600 15px/44px Inter,system-ui}
    .brand-search input::placeholder{color:var(--text-muted)}
    .chipset{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chipset .chk input{display:none}
    .chipset .chk label{display:inline-block;border:1px solid var(--stroke);background:var(--surface);padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--text);font-weight:600}
    .chipset .chk input:checked + label{border-color:var(--accent);background:var(--accent);color:#fff}

    /* Footer модалки */
    .footer{display:flex;gap:12px;padding:12px 16px;border-top:1px solid var(--stroke);background:var(--panel)}
    .footer .btn{height:44px;border-radius:var(--r-md);font-weight:700}
    .footer .btn.light{background:var(--panel);color:var(--text);border:1px solid var(--stroke)}
    .footer .btn.primary{background:var(--accent);color:#FFF;border:1px solid var(--accent)}

    /* ========================= SKELETONS ========================= */
    .skel{background:linear-gradient(90deg,#ece6db 25%,#f7f3ec 37%,#ece6db 63%);background-size:400% 100%;animation:skel 1.2s ease-in-out infinite;border-radius:var(--r-md)}
    @keyframes skel{0%{background-position:100% 50%}100%{background-position:0 50%}}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">V</div>
    <h1>Vinstory Club</h1>
  </header>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search"><input id="search" type="search" placeholder="Поиск" /></div>
    <button id="openFilters" class="pill">Фильтры</button>
    <button id="openSort" class="pill">Сортировка</button>
  </div>

  <!-- Horizontal brand chips -->
  <div class="cats"><div id="catsRow" class="cats-row"></div></div>

  <!-- Grid -->
  <div class="wrap">
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Ничего не нашли. Попробуйте изменить фильтры.</div>
  </div>

  <!-- PRODUCT MODAL -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <div style="font-weight:600" id="d-title">Товар</div>
        <button class="close" id="d-close">Закрыть</button>
      </header>
      <div class="dialog-scroll">
        <div class="gallery"><img id="d-big" class="big" src="" alt="Фото товара"></div>
        <div id="d-strip" class="strip"></div>
        <div class="content">
          <div id="d-meta" class="meta"></div>
          <div id="d-desc" class="desc"></div>
        </div>
      </div>
      <div class="buy">
        <div id="d-price" class="price"></div>
        <a id="d-tg" class="btn" target="_blank" rel="noopener">Написать</a>
      </div>
    </div>
  </div>

  <!-- FILTERS MODAL -->
  <div id="filtersModal" class="modal" aria-hidden="true">
    <div class="sheet small">
      <header>
        <div style="font-weight:600;font-size:16px">Фильтры</div>
        <button class="close" id="f-close">Закрыть</button>
      </header>
